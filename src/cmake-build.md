 # &#128293; Сборка программы в CMake

В этом разделе мы научимся собирать проекты программ, написанных на C++.
Поддерживает ли проект сборку посредством CMake можно узнать, если посмотреть в корневой каталог проекта и найти там файл `CMakeLists.txt`.

Здесь мы научимся:
* узнаем, что делает CMake;
* собирать проекты CMake и Eigen с помощью CMake;
* что такое сборка проекта и из каких этапов она состоит;
* что такое конфигурирование;


## Что делает CMake

CMake -- это система сборки проекта.
Она состоит из:
* утилит командой строки `cmake`, `ctest`, `cpack`;
* приложения `cmake-gui` с графическим интерфейсом;
* приложения `ccmake` с псевдографическим интерфейсом;
* языка сценариев;
* дополнительных модулей.

Все эти элементы служат для одной цели -- предоставить удобный инструмент для сборки проекта.
Сборка проекта -- это последовательность процессов превращения исходных кодов в правильно работающую программу.
В этой череде процессов компиляция -- только одна часть сборки.
Кроме нее туда входят конфигурирование, тестирование и упаковка.

В технологии программирования уже существуют инструменты, решающие эти задачи.
В UNIX-системах это make, autotools, а в Windows -- "Visual Studio".
В отличие от них, CMake предлагает одно решение под все платформы и достигает это меньшими усилиями.

CMake -- это фактический стандарт в разработке программ C++.


## Сборка CMake

Склонируем проект из [GitLab](https://gitlab.kitware.com/cmake/cmake) командой
```
git clone https://gitlab.kitware.com/cmake/cmake.git
```
После чего в текущем каталоге появится каталог `CMake`.
Перейдем туда.

Проект CMake может быть установленной версией себя.
Создадим каталог `build` в корне проекта командой `mkdir build`.

Перейдите в созданный каталог и запустите `cmake ..`.

```console
-- Performing Test HAVE_SOCKADDR_IN6_SIN6_SCOPE_ID
-- Performing Test HAVE_SOCKADDR_IN6_SIN6_SCOPE_ID - Success
-- Could NOT find OpenSSL, try to set the path to OpenSSL root folder in the system variable OPENSSL_ROOT_DIR (missing: OPENSSL_CRYPTO_LIBRARY OPENSSL_INCLUDE_DIR) 
CMake Error at Utilities/cmcurl/CMakeLists.txt:943 (message):
  Could not find OpenSSL.  Install an OpenSSL development package or
  configure CMake with -DCMAKE_USE_OPENSSL=OFF to build without OpenSSL.
```

В сообщении об ошибке содержится подсказка, как ее исправить.
Подскажем CMake, что мы хотим собрать проект без OpenSSL, запустив конфигурацию командой
```
cmake -DCMAKE_USE_OPENSSL=OFF ..
```

В действительности же нам необходимо установить OpenSSL.
```bash
sudo apt-get install libssl-dev
```

Запустим сборку командой `make`.

Полный сценарий сборки состоит из четырех команд:
```
mkdir build
cd build
cmake -DCMAKE_USE_OPENSSL=OFF ..
make
```


## Сборка Eigen

Проект [Eigen](https://eigen.tuxfamily.org/index.php?title=Main_Page) представляет C++-библиотеку для решения задач линейной алгебры.
Библиотека эффективно манипулирует с векторами и матрицами.

Чтобы получить исходные коды, скачайте архив [eigen-3.3.9.tar.gz](https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.gz) и распакуйте его командами:
```
curl --output ./eigen-3.3.9.tar.gz https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.gz
tar -xf eigen-3.3.9.tar.gz
```

Затем перейдите в появившийся каталог, создайте подкаталог `build` и запустите оттуда конфигурацию командами
```
cd eigen-3.3.9
mkdir build
cd build
cmake ..
```

В терминале появится следующее сообщение:
```
-- ************************************************************
-- 
-- Configured Eigen 3.3.9
-- 
-- Some things you can do now:
-- --------------+--------------------------------------------------------------
-- Command       |   Description
-- --------------+--------------------------------------------------------------
-- make install  | Install Eigen. Headers will be installed to:
--               |     <CMAKE_INSTALL_PREFIX>/<INCLUDE_INSTALL_DIR>
--               |   Using the following values:
--               |     CMAKE_INSTALL_PREFIX: /usr/local
--               |     INCLUDE_INSTALL_DIR:  include/eigen3
--               |   Change the install location of Eigen headers using:
--               |     cmake . -DCMAKE_INSTALL_PREFIX=yourprefix
--               |   Or:
--               |     cmake . -DINCLUDE_INSTALL_DIR=yourdir
-- make doc      | Generate the API documentation, requires Doxygen & LaTeX
-- make check    | Build and run the unit-tests. Read this page:
--               |   http://eigen.tuxfamily.org/index.php?title=Tests
-- make blas     | Build BLAS library (not the same thing as Eigen)
-- make uninstall| Removes files installed by make install
-- --------------+--------------------------------------------------------------
```

Из него можно узнать, что библиотеку можно установить в систему, собрать документацию и запустить модульные тесты.
Исходные коды библиотеки Eigen размещаются только в заголовочных файлах.
Такие библиотеки называют "header-only".
Они не требуют компиляции и подключаются в другие проекты сразу директивой `#include`.

Попробуйте запустить установку библиотеки в систему командой `make install`.
```console
tim@pc:~/eigen-3.3.9/build$ make install
Install the project...
-- Install configuration: "Release"
CMake Error at cmake_install.cmake:46 (file):
  file cannot create directory: /usr/local/include/eigen3.  Maybe need
  administrative privileges.


make: *** [Makefile:110: install] Ошибка 1
```

Вы получите сообщение об ошибке.
На запись в системные каталоги нужны права суперпользователя.
Но мы не будем запускать эту команду повторно с правами суперпользователя, а настроим установку в домашний каталог.
Для этого повторим этап конфигурации, но передав туда переменную `CMAKE_INSTALL_PREFIX=$HOME`:

`cmake -DCMAKE_INSTALL_PREFIX=$HOME ..`

Уже после установка завершится успешно.
Файлы библиотеки Eigen скопируются в каталоги `~/include` и `~/share`.


## Общий алгоритм сборки проектов

Общий алгоритм превращения проекта в рабочую программу состоит из пяти действий, первые три из которых обязательны (за исключением "header-only" библиотек):
1. добываем исходные коды проекта;
1. конфигурируем проект;
1. собираем проект;
1. тестируем программу;
1. устанавливаем программу.

### Добываем исходные коды

<!-- Добываем исходные коды -->
Исходные коды проекта можно получить как минимум двумя способами: склонировать утилитой `git` из Git-хостинга или загрузить в виде архивного файла.
В этом разделе мы воспользовались обоими способами.
В результате должен появиться каталог с файлами проекта.
Все последующие действия будут проходить внутри него или вложенных в него каталогах.

### Конфигурируем проект

<!-- Что такое конфигурирование проекта? -->
Что такое конфигурирование проекта?
Это поиск и фиксация информации из внешнего окружения, которая будет нужна для последующей сборки программы.

```{figure} ./images2/dependencies.png
```

Одну и ту же программу можно собрать по-разному, в зависимости от состояния внешнего окружения.
Внешнее окружение -- это все то, что не входит в состав каталога с проектом, но влияет на его превращение в программу.
Сюда входят:
* платформа, т.е. комбинация операционной системы и архитектуры процессора;
* утилиты компилятора;
* сторонние библиотеки;
* система сборки CMake;
* система контроля версий Git;
* переменные окружения;
* дополнительные файлы и каталоги;
* и что-то еще.

Все эти элементы называются *внешними зависимостями*.
Их разделяют на две части: *обязательные* и *дополнительные*.
Без обязательных внешних зависимостей проект не может быть собран в программу.
Без дополнительных внешних зависимостей собранной программе будет не доставать некоторой функциональности.

Так, кроссплатформенная программа может быть собрана на разных платформах: Windows, Linux, MacOS.
Программа может быть собрана разным уровнем функциональности, в зависимости от типа лицензии или доступности внешних зависимостей.

На этапе конфигурирования CMake анализирует внешнее окружение и инициализирует переменные CMake.
В этих переменных содержатся пути к внешним зависимостям, которые будут переданы компилятору и использованы с опциями `-L`, `-I` и `-l`.

Переменные CMake также могут быть переданы компилятору через опцию `-D` в виде переменных препроцессора.
На основе этих переменных в исходных кодах будет подключен или отключен участок исходного кода.
Стандартными переменными такого рода являются `NDEBUG`, `WIN32`, `LINUX`.

Некоторые переменные CMake могут стать константными статическими переменными языка программирования.
Для этого генерируется заголовочный файл, в котором будут прописаные переменные с предопределенными именами, и значениями, добытыми на этапе конфигурирования.
Исходный код, где необходимы эти данные, будут подключать этот заголовочный файл и использовать переменную.
Примером такой переменной может являться версия, имя производителя или дата сборки программного обеспечения.

### Собираем проект

В результате сборки проекта появятся дополнительные файлы, называемые *артефактами сборки*.
Это файлы с такими шаблонными именами как `*.so`, `*.a`, `moc_*.cpp`, `*.obj`; сгенерированные автоматически утилитами `flex`, `bison`, `cmake`.
Артефакты можно смело удалять, так как они создаются автоматически при каждой сборке.
Единственное, что надо -- хранить их в отдельном каталоге и не смешивать с исходными кодами.
CMake работает с двумя каталогами:
* каталог исходных кодов (каталог проекта);
* каталог двоичных файлов (артефактов сборки).

В любой момент вы можете удалить второй каталог и начать все заново.
Эта особенность выгодно отличает CMake от других систем сборки как например make.

Создайте каталог двоичных файлов и перейдите в него командами:
```
mkdir build
cd build
```

Каталог `build` может быть занят.
Во-первых он может быть частью проекта, тогда подберите другое имя каталогу, например `bld`.
Во-вторых каталог может быть уже создан и в нем хранятся артефакты сборки, тогда удалите его командой `rm -rf build`.

Как узнать, что каталог создан под сборку CMake проекта?
Если в каталоге есть файл `CMakeCache.txt`, то это каталог CMake для двоичных файлов.

<!-- Про генераторы -->


### Тестируем и устанавливаем программу


## Вопросы для самоконтроля

1. На что можно повлиять на этапе конфигурации проекта?


## Упражнения

1. При конфигурации Eigen в терминале просказльзывает сообщение, что UMFPACK не найден.
   Попробуйте собрать библиотеку с зависимостью [UMFPACK](https://en.wikipedia.org/wiki/UMFPACK).
